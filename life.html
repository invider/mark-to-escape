<html>
    <head><title>Life</title></head>
    <script src="jam/scene.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html, body {
            background-color: #444444;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
    <body>
        <script>
        "use strict"

        this['@lab/field'] = {
            info: 'life field',

            EVO: 1,
            SIZE: 7,

            step: 0,
            field: [],
            width: 300,
            height: 150,

            get: function(x, y) {
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) return 0
                return this.field[y * this.height + x]
            },
            isAlive: function(x, y) {
                let v = this.get(x, y)
                if (v && v !== true && v !== 0) return true
                return false
            },
            set: function(x, y, v) {
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) return
                this.field[y * this.height + x] = v
            },
            update: function(x, y) {
                if (!this.get(x, y)) {
                    this.set(x, y, 1)
                } else {
                    this.set(x, y, this.get(x, y) + 1)
                }
            },
            kill: function(x, y) {
                this.set(x, y, -1)
            },
            shift: function(x, y) {
                let v = this.get(x, y)
                if (v === true) this.set(x, y, 1)
                else if (v < 0) this.set(x, y, 0)
            },
            neighbours: function(x, y) {
                let i = 0
                if (this.isAlive(x-1, y-1)) i++
                if (this.isAlive(x-1, y)) i++
                if (this.isAlive(x-1, y+1)) i++
                if (this.isAlive(x, y-1)) i++
                if (this.isAlive(x, y+1)) i++
                if (this.isAlive(x+1, y-1)) i++
                if (this.isAlive(x+1, y)) i++
                if (this.isAlive(x+1, y+1)) i++
                return i
            },

            fill: function(x, y, list) {
                let t = this
                list.forEach( function(e) {
                    t.update(e[0]+x, e[1]+y)
                })
            },
            

            load: function(_) {
                _.log.out('loading...')
                this.fill(20, 10, [
                    [1, 2],
                    [2, 1],
                    [2, 2],
                    [2, 3],
                    [3, 2],
                    ])

                this.fill(30, 20, [
                    [2, 1],
                    [2, 2],
                    [2, 3],
                    ])

            },

            active: true,
            evo: function(scene, delta) {
                this.step += delta
                if (this.step > this.EVO) {
                    this.step -= this.EVO

                    // evolve
                    for (let x = 0; x < this.width; x++) {
                        for (let y = 0; y < this.height; y++) {
                            let n = this.neighbours(x, y)
                            if (this.isAlive(x, y)) {
                                if (n < 2 || n > 3) {
                                    this.kill(x, y)
                                } else {
                                    this.update(x, y)
                                }
                            } else {
                                if (n === 3) {
                                    this.set(x, y, true)
                                }
                            }
                        }
                    }

                    for (let x = 0; x < this.width; x++) {
                        for (let y = 0; y < this.height; y++) {
                            this.shift(x, y)
                        }
                    }
                }
            },

            visible: true,
            draw: function(ctx) {
                // clear the screen
                ctx.fillStyle = "#220044"
                ctx.fillRect(0, 0, canvas.width, canvas.height)

                // draw dot
                for (let x = 0; x < this.width; x++) {
                    for (let y = 0; y < this.height; y++) {
                        let cell = this.get(x, y)
                        if (cell && cell > 0) {
                            ctx.fillStyle="#FF0040";
                            ctx.fillRect(x * this.SIZE, y * this.SIZE, this.SIZE, this.SIZE); 
                        }
                    }
                }
            }
        }

        </script>
    </body>
</html>
